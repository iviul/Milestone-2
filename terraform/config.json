{
  "project": {
    "name": "my-infra",
    "environment": "dev",
    "region": "europe",
    "os": "ubuntu",
    "terraform_username": "terraform_user",
    "state_bucket_location_gcp": "europe-west3a",
    "state_bucket_location_aws": "eu-central-1",
    "bucket_state_name": "state-bucket-name-1377"
  },

  "network": [
    {
      "name": "main",
      "vpc_cidr": "10.0.0.0/16",
      "subnets": [
        {
          "name": "public-subnet",
          "cidr": "10.0.1.0/24",
          "public": true,
          "zone": "a"
        },
        {
          "name": "private-subnet",
          "cidr": "10.0.2.0/24",
          "public": false,
          "zone": "b"
        },
        {
          "name": "private-subnet-2",
          "cidr": "10.0.3.0/24",
          "public": false,
          "zone": "a"
        }
      ]
    }
  ],

  "vm_instances": [
    {
      "name": "reverse-proxy",
      "network": "main",
      "size": "small",
      "zone": "a",
      "subnet": "public-subnet",
      "tags": ["proxy"],
      "port": 80,
      "security_groups": ["reverse-proxy-sg"]
    },
    {
      "name": "frontend",
      "network": "main",
      "size": "small",
      "zone": "b",
      "subnet": "private-subnet",
      "tags": ["frontend"],
      "port": 3000,
      "security_groups": ["frontend-sg"]
    },
    {
      "name": "backend",
      "network": "main",
      "size": "small",
      "zone": "b",
      "subnet": "private-subnet",
      "tags": ["backend"],
      "port": 8080,
      "security_groups": ["backend-sg"]
    },
    {
      "name": "redis",
      "network": "main",
      "size": "small",
      "zone": "b",
      "subnet": "private-subnet",
      "tags": ["cache"],
      "port": 6379,
      "security_groups": ["redis-sg"]
    },
    {
      "name": "bastion",
      "network": "main",
      "size": "small",
      "zone": "a",
      "subnet": "public-subnet",
      "tags": ["bastion", "ssh"],
      "port": 22,
      "security_groups": ["bastion-sg"]
    }
  ],

  "databases": [
    {
      "name": "maindb",
      "network": "main",
      "type": "postgres",
      "version": "14",
      "size": "small",
      "zone": ["a", "b"],
      "subnets": ["private-subnet", "private-subnet-2"],
      "port": 5432,
      "security_groups": ["db-sg"]
    }
  ],

  "networks": [
    { "name": "public", "cidr": "0.0.0.0/0" },
    { "name": "internal", "cidr": "10.0.0.0/16" }
  ],

  "security_groups": [
    {
      "name": "reverse-proxy-sg",
      "vpc": "main",
      "attach_to": ["reverse-proxy"],
      "description": "Allow public HTTP traffic and forward to front/back",
      "ingress": [
        { "protocol": "tcp", "port": 80, "source": "public" }
      ],
      "egress": [
        { "protocol": "tcp", "port": 3000, "destination": "frontend-sg" },
        { "protocol": "tcp", "port": 8080, "destination": "backend-sg" }
      ]
    },
    {
      "name": "frontend-sg",
      "vpc": "main",
      "attach_to": ["frontend"],
      "description": "Serve assets to proxy",
      "ingress": [
        { "protocol": "tcp", "port": 3000, "source": "reverse-proxy-sg" }
      ],
      "egress": []
    },
    {
      "name": "backend-sg",
      "vpc": "main",
      "attach_to": ["backend"],
      "description": "API server behind proxy with DB/Redis access",
      "ingress": [
        { "protocol": "tcp", "port": 8080, "source": "reverse-proxy-sg" }
      ],
      "egress": [
        { "protocol": "tcp", "port": 5432, "destination": "db-sg" },
        { "protocol": "tcp", "port": 6379, "destination": "redis-sg" }
      ]
    },
    {
      "name": "db-sg",
      "vpc": "main",
      "attach_to": ["maindb"],
      "description": "PostgreSQL accessible only from backend",
      "ingress": [
        { "protocol": "tcp", "port": 5432, "source": "backend-sg" }
      ],
      "egress": []
    },
    {
      "name": "redis-sg",
      "vpc": "main",
      "attach_to": ["redis"],
      "description": "Redis accessible only from backend",
      "ingress": [
        { "protocol": "tcp", "port": 6379, "source": "backend-sg" }
      ],
      "egress": []
    },
    {
      "name": "bastion-sg",
      "vpc": "main",
      "attach_to": ["bastion"],
      "description": "Allow SSH from admin IP to private network",
      "ingress": [
        { "protocol": "tcp", "port": 22, "source": "203.0.113.0/24" }
      ],
      "egress": [
        { "protocol": "tcp", "port": 22, "destination": "frontend-sg" },
        { "protocol": "tcp", "port": 22, "destination": "backend-sg" },
        { "protocol": "tcp", "port": 22, "destination": "redis-sg" },
        { "protocol": "tcp", "port": 22, "destination": "db-sg" }
      ]
    }
  ]
}